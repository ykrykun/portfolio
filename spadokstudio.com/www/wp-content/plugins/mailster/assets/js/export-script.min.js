mailster=function(s,r,c,l){"use strict";var u=r(".status");s.events.push("documentReady",e);s.events.push("documentReady",function(){r.fn.sortable&&r(".export-order").sortable({connectWith:".export-order",_placeholder:"ui-state-highlight",containment:".export-order-wrap",receive:function(e,t){t.item.find("input").prop("checked",t.item.closest(".export-order").is(".selected"))}}).on("change","input",function(){var e=r(this);e.parent().appendTo(e.is(":checked")?r(".export-order.selected"):r(".export-order.unselected"))})});s.$.document.on("change","#export-subscribers input,#export-subscribers select",e).on("click",".export-order-add",function(){r(".export-order.unselected").find("li").appendTo(".export-order.selected").find("input").prop("checked",true);return false}).on("click",".export-order-remove",function(){r(".export-order.selected").find("li").appendTo(".export-order.unselected").find("input").prop("checked",false);return false}).on("change",'select[name="outputformat"]',function(){r("#csv-separator")[r(this).val()=="csv"?"show":"hide"]()}).on("change",".list-toggle",function(){r(this).parent().parent().parent().find("ul input").prop("checked",r(this).prop("checked"))}).on("submit","#export-subscribers",function(){var n=r(this).serialize();s.util.ajax("export_contacts",{data:n},function(e){if(e.success){c.onbeforeunload=function(){return s.l10n.manage.onbeforeunloadexport};var t=r(".performance").val();u.addClass("progress");d(0,t,e.data.count,n)}else{alert(e.data.msg)}},function(e,t,n){alert(t)});return false});function d(n,r,o,a){var e=(new Date).getTime(),i=Math.min(1,r*n/o)*100;u.html(s.util.sprintf(s.l10n.manage.prepare_download,o,""));s.util.ajax("do_export",{limit:r,offset:n,data:a},function(e){var t=i>=100&&e.data.finished;if(e.success){if(!t)d(n+1,r,o,a);u.html(s.util.sprintf(s.l10n.manage.prepare_download,o,Math.ceil(i)+"%"));if(t){c.onbeforeunload=null;u.html(s.l10n.manage.export_finished);u.html(s.util.sprintf(s.l10n.manage.downloading,o));if(e.data.filename){setTimeout(function(){u.removeClass("progress");l.location=e.data.filename},2e3)}}else{u.html(s.util.sprintf(s.l10n.manage.write_file,e.data.total,Math.ceil(i)+"%"))}}else{c.onbeforeunload=null;u.html(s.l10n.manage.error_export);alert(e.data.msg)}},function(e,t,n){})}function e(){setTimeout(function(){var e=r("#export-subscribers").serialize();r("#export-subscriber-button").prop("disabled",true);s.util.ajax("get_subscriber_count",{data:e},function(e){if(e.success){r("#export-subscriber-button").val(s.util.sprintf(s.l10n.manage.export_n_subscribers,e.data.count_formated)).prop("disabled",!e.data.count)}})},10)}return s}(mailster||{},jQuery,window,document);