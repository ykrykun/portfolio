mailster=function(C,M,A,e){"use strict";var t={},q=C.$.editbar,j,a={img:0,single:80,multi:0,btn:0,auto:0,codeview:0},T=q.find(".imagepreview"),D=q.find(".imagewidth"),N=q.find(".imageheight"),E=q.find(".imagecrop"),$=q.find(".factor"),O=q.find(".highdpi"),z=q.find(".original"),I=q.find(".imagelink"),R=q.find(".imageurl"),H=q.find(".orgimageurl"),W=q.find(".imagealt"),L=q.find(".singlelink"),S=q.find(".buttonlink"),B=q.find(".buttonlabel"),J=q.find(".buttonalt"),V=q.find(".button-nav"),i=q.find("ul.buttons"),U,w,F,K,k,Q,G,P,n,l,s,r,o,X="",d=false,Y=M("#post-search"),Z=M("#image-search"),c=M('[name="image-search-type"]');q.on("keyup change","input.live",v).on("keyup change","#mailster-editor",v).on("click",".replace-image",u).on("change",".highdpi",p).on("click","button.save",b).on("click",".cancel",_).on("click","a.remove",y).on("click","a.reload",de).on("click","a.single-link-content",he).on("click","a.add_image",ge).on("click","a.add_image_url",pe).on("click",".imagelist li",le).on("dblclick",".imagelist li",b).on("change","#post_type_select input",de).on("click",".postlist li",se).on("click",".load-more-posts",ce).on("click","a.btnsrc",ie).on("click",".imagepreview",ne).on("click","a.nav-tab",ee).on("change","select.check-for-posts",g).on("change paste","#dynamic_rss_url",g).on("keyup change","#post-search",fe).on("keyup change","#image-search",fe).on("change",'[name="image-search-type"]',fe).on("mouseenter","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",m).on("mouseleave","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",f).on("click",".current-tag a",false).on("keypress.mailster",function(e){if(e.keyCode==13&&e.target.nodeName.toLowerCase()!="textarea")return false}).on("keyup.mailster",function(e){switch(e.keyCode){case 27:_();return false;break;case 13:if(F.type!="multi"&&F.type!="codeview"){b();return false}break}});M(".imagelist, .postlist").on("scroll",C.util.throttle(me,500));C.util.getRealDimensions(C.$.iframe.contents().find("img").eq(0),function(e,t,a){var i=a>=1.5;$.val(a);O.prop("checked",i);i?q.addClass("high-dpi"):q.removeClass("high-dpi")});V.on("click","a",function(){M(this).parent().find("a").removeClass("nav-tab-active");M(this).parent().parent().find("ul.buttons").hide();var e=M(this).addClass("nav-tab-active").attr("href");M("#tab-"+e.substr(1)).show();return false});R.on("paste change",function(a){var i=M(this);setTimeout(function(){var e=x(i.val()),t=new Image;if(e){ae();t.onload=function(){T.attr("src",e);K={width:F.width||t.width,height:Math.round((F.width||t.width)/(t.width/t.height)),asp:t.width/t.height};N.val(K.height);ae(false)};t.onerror=function(){if(a.type!="paste")alert(C.util.sprintf(C.l10n.campaigns.invalid_image,'"'+e+'"'))};t.src=e}},1)});D.on("keyup change",function(){if(!E.is(":checked"))N.val(Math.round(D.val()/K.asp));re()});N.on("keyup change",function(){if(!E.is(":checked"))D.val(Math.round(N.val()*K.asp));re()});E.on("change",function(){if(!E.is(":checked")){N.val(Math.round(D.val()/K.asp));E.parent().removeClass("not-cropped")}else{E.parent().addClass("not-cropped")}re()});M("#dynamic_embed_options_post_type").on("change",function(){var t=M("#dynamic_embed_options_cats"),e=M(this).val();t.find("select").prop("disabled",true);q.find(".dynamic-rss")[e=="rss"?"show":"hide"]();ae();C.util.ajax("get_post_term_dropdown",{posttype:e},function(e){ae(false);if(e.success){t.html(e.data.html);if(Q&&Q.terms){var l=t.find(".dynamic_embed_options_taxonomy_wrap");M.each(Q.terms,function(n,e){if(!e)return;var t=e.split(",");M.each(t,function(e,t){var a=l.eq(n).find("select").eq(e),i;if(!a.length){i=l.eq(n).find("select").last();a=i.clone();a.insertAfter(i);M("<span> "+C.l10n.campaigns.or+" </span>").insertBefore(a)}a.val(t)})})}}g()},function(e,t,a){ae(false)})});C.events.documentReady.push(function(){q.draggable&&q.draggable({distance:20,axis:"y"});if(C.util.isTinyMCE&&tinymce.get("mailster-editor")){if(tinymce.majorVersion>=4){tinymce.get("mailster-editor").on("keyup",function(){ve(this)});tinymce.get("mailster-editor").on("ExecCommand",function(){ve(this)})}else{tinymce.get("mailster-editor").onKeyUp.add(function(){ve(this)});tinymce.get("mailster-editor").onExecCommand.add(function(){ve(this)})}}});function m(){h(false)}function f(){h(true)}function h(e){if(q.draggable){if(e!==false){q.draggable("enable")}else{q.draggable("disable")}}}function ee(e,t){var a;if(typeof e=="string"){a=j.find('a[href="'+e+'"]')}else{a=M(this);e=a.attr("href")}a.parent().find("a.nav-tab").removeClass("nav-tab-active");a.addClass("nav-tab-active");j.find(".tab").hide();j.find(e).show();if(e=="#dynamic_embed_options"&&t!==false)M("#dynamic_embed_options_post_type").trigger("change");if(e=="#image_button")w="image";if(e=="#text_button")w="text";P=j.find(e).find(".postlist").eq(0);return false}function u(){ae();var e=$.val(),t=F.element.width(),a=Math.round(t/1.6),i=M("<img>",{src:"https://dummy.mailster.co/"+t*e+"x"+a*e+".jpg",alt:F.content,label:F.content,width:t,height:a,border:0,editable:F.content});i[0].onload=function(){i.attr({width:t,height:a}).removeAttr("style");be()};if(F.element.parent().is("a"))F.element.unwrap();if(!F.element.parent().is("td"))F.element.unwrap();F.element.replaceWith(i);return false}function p(){if(M(this).is(":checked")){$.val(2);q.addClass("high-dpi")}else{$.val(1);q.removeClass("high-dpi")}}function g(){clearInterval(l);ae();l=setTimeout(function(){var e=q.find("#dynamic_embed_options_post_type").val(),t=q.find("#dynamic_embed_options_content").val(),a=q.find("#dynamic_embed_options_relative").val(),i=q.find(".dynamic_embed_options_taxonomy_wrap"),n=M("#dynamic_rss_url").val(),l={},r=[];M.each(i,function(e){var t=M(this).find("select"),a=[];M.each(t,function(){var e=parseInt(M(this).val(),10);if(e!=-1&&M.inArray(e,a)==-1&&!isNaN(e))a.push(e)});a=a.join(",");if(a)r[e]=a});l={id:C.campaign_id,post_type:e,relative:a,extra:r,content:t,modulename:F.name,expect:F.elements.expects,rss_url:n};if(JSON.stringify(l)===JSON.stringify(s)){ae(false);return}M("#dynamic_embed_options").find("h4.current-match").html("&hellip;");M("#dynamic_embed_options").find("div.current-tag").html("&hellip;");if("rss"==e&&!n){ae(false);return}s=l;C.util.ajax("check_for_posts",l,function(e){ae(false);if(e.success){k=e.data.pattern;M("#dynamic_embed_options").find("h4.current-match").html(e.data.title);M("#dynamic_embed_options").find("div.current-tag").text(e.data.pattern.title+"\n\n"+e.data.pattern[t])}},function(e,t,a){ae(false)})},500)}function x(e,t,a,i,n){t=t||D.val();a=a||N.val()||Math.round(t/1.6);i=typeof i=="undefined"?E.prop(":checked"):i;n=typeof n=="undefined"?z.prop(":checked"):n;if(/^\{(.+)\}$/.test(e)){var l=$.val();e=C.ajaxurl+"?action=mailster_image_placeholder&tag="+e.replace("{","").replace("}","")+"&w="+Math.abs(t)+"&h="+Math.abs(a)+"&c="+(i?1:0)+"&o="+(n?1:0)+"&f="+l}return e}function te(e){if(-1!==e.indexOf("?action=mailster_image_placeholder&tag=")){var t=e.match(/&tag=([a-z0-9-_,;:|~]+)&/);return"{"+t[1]+"}"}return false}function v(e){if((e.keyCode||e.which)!=27&&F)F.element.html(M(this).val())}function ae(e){if(e===false){M("#editbar-ajax-loading").hide();q.find(".buttons").find("button").prop("disabled",false);d=false}else{d=true;M("#editbar-ajax-loading").css("display","inline");q.find(".buttons").find("button").prop("disabled",true)}}function b(){if(F.type=="img"){var n=F.element.is("img");if(R.val()){K={id:null,name:"",src:x(R.val()),width:K.width,height:K.height,asp:K.width/K.height}}if(K){ae();var l=$.val()||1,e=D.val(),t=N.val(),r=E.is(":checked"),s=z.is(":checked"),o=n?"src":"background",a;F.element.attr({"data-id":K.id}).data("id",K.id).addClass("mailster-loading");if(n){F.element.attr({src:K.src,alt:K.name});if(!F.is_percentage){F.element.attr("width",Math.round(e))}if(F.element.attr("height")&&F.element.attr("height")!="auto"){F.element.attr("height",Math.round(t))}if(r){F.element.attr({"data-crop":true}).data("crop",true)}if(s){F.element.attr({"data-original":true}).data("original",true)}}if(K.src){F.element.attr(o,K.src);if(a=F.element.attr("style")){F.element.attr("style",a.replace(/url\("?(.+)"?\)/,"url('"+K.src+"')"))}}C.util.ajax("create_image",{id:K.id,original:s,src:K.src,width:e*l,height:t*l,crop:r},function(t){ae(false);if(t.success){T.attr("src",t.data.image.url);t.data.image.width=(t.data.image.width||K.width)/l;t.data.image.height=t.data.image.width/K.asp;t.data.image.asp=K.asp;K=t.data.image;K.name=W.val();if(n){F.element.one("load error",function(e){if("error"==e.type){alert(C.util.sprintf(C.l10n.campaigns.invalid_image,t.data.image.url))}F.element.removeClass("mailster-loading");C.trigger("save")});F.element.attr({alt:K.name});if(!F.is_percentage){F.element.attr("width",Math.round(D.val()))}if(F.element.attr("height")&&F.element.attr("height")!="auto"){F.element.attr("height",Math.round(N.val()))}if(r){F.element.attr({"data-crop":true}).data("crop",true)}if(s){F.element.attr({"data-original":true}).data("original",true)}}else{F.element.removeClass("mailster-loading");var e=F.element.html(),a=e.match(/<modules/),i;if(H.val()){if(a){if(a=e.match(new RegExp("<v:background(.*)</v:background>","s"))){F.element.html(C.util.replace(e,a[0],C.util.replace(a[0],H.val(),K.url)))}}else{F.element.html(C.util.replace(e,H.val(),K.url));F.element.find("single, multi").removeAttr("id")}}}F.element.removeAttr(o).attr(o,K.url)}else{F.element.removeClass("mailster-loading")}W.val("");be()},function(e,t,a){ae(false)})}else{F.element.attr({alt:W.val()});be()}if(F.element.parent().is("a"))F.element.unwrap();var i=I.val();if(i)F.element.wrap('<a href="'+i+'"></a>');return false}else if(F.type=="btn"){var i=S.val();if(!i&&!confirm(C.l10n.campaigns.remove_btn))return false;var d=j.find("a.active").find("img").attr("src");if(typeof d=="undefined"){w="text";if(!B.val())B.val(C.l10n.campaigns.read_more)}F.element.removeAttr("tmpbutton");if("image"==w){var l=$.val();var c=new Image;c.onload=function(){if(!F.element.find("img").length){var e=F.element.closest(".textbutton");var t=M('<a href="" editable label="'+F.name+'"><img></a>');e.length?e.replaceWith(t):F.element.replaceWith(t);F.element=t}F.element.find("img").attr({src:d,width:Math.round((c.width||F.element.width())/l),height:Math.round((c.height||F.element.height())/l),alt:J.val()});i?F.element.attr("href",i):F.element.remove();be()};c.src=d}else{var m=F.element.closest(".textbutton"),f=B.val();if(!m.length){F.element.replaceWith('<table class="textbutton" align="left" role="presentation"><tr><td align="center" width="auto"><a href="'+i+'" editable label="'+f+'">'+f+"</a></td></tr></table>")}else{if(F.element[0]==m[0]){F.element=m.find("a")}F.element.text(f)}if(i){F.element.attr("href",i)}else{F.element.remove();m.remove()}be()}return false}else if(F.type=="auto"){var h=M("#embedoption-bar").find(".nav-tab-active").data("type"),u=F.element.data("position")||0,p,g=[],v,b;F.element.removeAttr("data-tag data-rss").removeData("tag").removeData("data-rss");if("dynamic"==h){p=q.find("#dynamic_embed_options_content").val();v=q.find("#dynamic_embed_options_post_type").val();b=M("#dynamic_rss_url").val();k.content=k[p];F.element.attr("data-tag",k.tag).data("tag",k.tag);if("rss"==v){F.element.attr("data-rss",b).data("rss",b)}}else{p=M(".embed_options_content:checked").val();F.element.removeAttr("data-tag").removeData("tag")}if(k){if(F.elements.single.length){F.elements.single.each(function(e,t){var a=M(this),i=a.attr("expect")||"title",n=k[i]?k[i]:"";if(n&&!a.is("[ignore]"))a.html(n)})}if(F.elements.multi.length){F.elements.multi.each(function(e,t){var a=M(this),i=a.attr("expect")||p,n=k[i]?k[i]:"";if(n&&!a.is("[ignore]"))a.html(n)})}if(k.link){F.elements.buttons.each(function(e,t){var a=M(this),i=a.attr("expect")||"link",n=k[i]?k[i]:"";if(a.is("[ignore]"))return;if(n)a.attr("href",n);if(k["button"])a.html(k["button"])})}else{if(F.elements.buttons.parent().length&&F.elements.buttons.parent()[0].nodeName=="TD"){F.elements.buttons.closest(".textbutton").remove()}else if(F.elements.buttons.length){if(F.elements.buttons.last().find("img").length){F.elements.buttons.remove()}}}if(k.image&&F.elements.images.length){ae();F.elements.images.each(function(e,t){var a=M(this),i=$.val();if("static"==h){k.image.id&&C.util.ajax("create_image",{id:k.image.id,original:z.is(":checked"),width:a.width()*i,height:a.height()*i,crop:a.data("crop")},function(e){if(e.success){ae(false);if(z.is(":checked")){a.attr("data-original",true).data("original",true)}if("img"==a.prop("tagName").toLowerCase()){a.attr({"data-id":k.image.id,src:e.data.image.url,width:Math.round(e.data.image.width/i),alt:k.alt||k.title}).data("id",k.image.id);if(a.attr("height")&&a.attr("height")!="auto"){a.attr("height",Math.round(e.data.image.height/i))}if(a.parent().is("a")){a.unwrap()}if(k.link){a.wrap('<a href="'+k.link+'">')}}else{var t=a.attr("background");a.attr({"data-id":k.image.id,background:e.data.image.url}).data("id",k.image.id);F.element.html(C.util.replace(F.element.html(),t,e.data.image.url));F.element.find("single, multi").removeAttr("id");C.trigger("save");C.trigger("refresh")}}},function(e,t,a){ae(false)});return false}else if("dynamic"==h){var n=a.width(),l=a.data("crop"),r=z.is(":checked"),s=l?a.height():null;if("img"==a.prop("tagName").toLowerCase()){a.removeAttr("data-id").attr({src:x(k.image,n,s,l,r),width:n,alt:k.alt||k.title}).removeData("id");if(a.attr("height")){a.attr("height",s||Math.round(n/1.6))}}else{var o=a.attr("background");a.removeAttr("data-id").attr({background:x(k.image,n)}).removeData("id");F.element.html(C.util.replace(F.element.html(),o,x(k.image,n,s,l,r)));F.element.find("single, multi").removeAttr("id")}}})}u=u+1>=F.areas.length?0:u+1;F.element.data("position",u);C.$.iframe.contents().find("html").find("img").each(function(){this.onload=function(){C.trigger("refresh")}})}}else if(F.type=="multi"){if(C.util.isTinyMCE&&tinymce.get("mailster-editor")&&!tinymce.get("mailster-editor").isHidden()){var y=tinymce.get("mailster-editor").getContent();y=y.replace('href="http://{','href="{');F.element.html(y)}}else if(F.type=="single"){if(F.conditions){F.aa="<if";M.each(M(".conditinal-area"),function(){F.aa=""})}if(F.element.parent().is("a"))F.element.unwrap();var i=L.val();if(i)F.element.wrap('<a href="'+i+'"></a>')}else if(F.type=="codeview"){var _=U.codemirror.getValue();F.element.html(_);F.modulebuttons.prependTo(F.element)}be();return false}function y(){if(F.element.parent().is("a"))F.element.unwrap();if("btn"==F.type){var e=F.element.closest(".textbutton"),t=e.parent();if(!e.length){e=F.element}if(t.is("buttons")&&!t.find(".textbutton").length){t.remove()}else{e.remove()}}else if("img"==F.type&&"img"!=F.tag){F.element.attr("background","")}else{F.element.remove()}be();return false}function _(){switch(F.type){case"img":case"btn":if(F.element.is("[tmpbutton]")){F.element.remove()}break;default:F.element.html(F.content);F.element.find("single, multi").removeAttr("id")}be();return false}function ie(){var e=M(this),t=e.data("link");j.find(".btnsrc").removeClass("active");e.addClass("active");J.val(e.attr("title"));if(t){var a;S.val(t);if((a=(t+"").indexOf("USERNAME",0))!=-1){S.focus();selectRange(S[0],a,a+8)}}return false}function ne(){M(this).toggleClass("zoom")}function le(e,t){var a=t||M(this),i=a.data("id"),n=a.data("name"),l=a.data("src");if(!i)return;K={id:i,name:n,src:l};ae();j.find("li.selected").removeClass("selected");a.addClass("selected");if(F.element.data("id")==i){W.val(F.element.attr("alt"))}else if(F.element.attr("alt")!=n){W.val(n)}R.val("");T.attr("src","").on("load",function(){T.off("load");F.width=T.width();F.height=T.height();F.asp=a.data("asp")||F.width/F.height;K.asp=F.asp;ae(false);if(!E.is(":checked"))N.val(Math.round(D.val()/F.asp));re()}).attr("src",l);return K}function re(){var e=Math.round(.5*(F.height-F.width*(N.val()/D.val())))||0,t=parseInt($.val(),10);T.css({clip:"rect("+e+"px,"+F.width*t+"px,"+(F.height*t-e)+"px,0px)","margin-top":-1*e+"px"})}function se(){var t=M(this),e=t.data("id"),a=t.data("name"),i=t.data("link"),n=t.data("thumbid");if(F.type=="btn"){S.val(i);J.val(a);j.find("li.selected").removeClass("selected");t.addClass("selected")}else if(F.type=="single"){L.val(i);j.find("li.selected").removeClass("selected");t.addClass("selected")}else{ae();C.util.ajax("get_post",{id:e,expect:F.elements.expects},function(e){ae(false);j.find("li.selected").removeClass("selected");t.addClass("selected");if(e.success){k=e.data.pattern;j.find(".editbarinfo").html(C.l10n.campaigns.curr_selected+": <span>"+k.title+"</span>")}},function(e,t,a){ae(false);j.find("li.selected").removeClass("selected")})}return false}function oe(e){F=e;var o=e.element,d=o.closest("module"),t=m!="img"?e.offset.top:0,c=e.name||"",m=e.type,f=C.util.trim(o.html()),a=o.find("if"),h,u=F.element.data("position")||0,i,n,l,p=1;j=q.find("div.type."+m);q.addClass("current-"+m);F.width=o.width();F.height=o.height();F.asp=F.width/F.height;F.crop=o.data("crop")?o.data("crop"):false;F.tag=o.prop("tagName").toLowerCase();F.is_percentage=o.attr("width")&&o.attr("width").indexOf("%")!==-1;F.content=f;Q=F.element.data("tag");X="";C.trigger("selectModule",d);if(a.length){h={if:null,elseif:[],else:null,total:0};h=[];q.addClass("has-conditions");i=j.find(".conditinal-area");n=q.find(".conditions").eq(0);n.clone().prependTo(i);M.each(a.find("elseif"),function(){var e=M(this),t=e.html();h.push({el:e,html:t,field:e.attr("field"),operator:e.attr("operator"),value:e.attr("value")});e.detach();i.clone().val(t).insertAfter(i)});M.each(a.find("else"),function(){var e=M(this),t=e.html();h.push({el:e,html:t});e.detach();i.clone().val(t).insertAfter(i)});h.unshift({el:a,html:a.html(),field:a.attr("field"),operator:a.attr("operator"),value:a.attr("value")})}else{q.removeClass("has-conditions")}F.conditions=h;if(m=="img"){z.prop("checked",F.original);E.prop("checked",F.crop).parent()[F.crop?"addClass":"removeClass"]("not-cropped");X=C.util.trim(Z.val());$.val(1);C.util.getRealDimensions(o,function(e,t,a){var t=a>=1.5;$.val(a);O.prop("checked",t);t?q.addClass("high-dpi"):q.removeClass("high-dpi");p=a})}else if(m=="btn"){if(o.find("img").length){M("#button-type-bar").find("a").eq(1).trigger("click");var g=o.find("img").attr("src");if(V.length){var r=q.find("img[src='"+g+"']");if(r.length){q.find("ul.buttons").hide();var s=r.parent().parent().parent();q.find('a[href="#'+s.attr("id").substr(4)+'"]').trigger("click")}else{M.each(q.find(".button-nav"),function(){M(this).find(".nav-tab").eq(0).trigger("click")})}}B.val(o.find("img").attr("alt"));C.util.getRealDimensions(o.find("img"),function(e,t,a){var t=a>=1.5;$.val(a);O.prop("checked",t);t?q.addClass("high-dpi"):q.removeClass("high-dpi");p=a})}else{M("#button-type-bar").find("a").eq(0).trigger("click");B.val(C.util.trim(o.text())).focus().select();S.val(F.element.attr("href"));q.find("ul.buttons").hide()}}else if(m=="auto"){ee("#"+(Q?"dynamic":"static")+"_embed_options",true);X=C.util.trim(Y.val());if(Q){var v=Q.substr(1,Q.length-2).split(":"),b=v[1].split(";"),y=b.shift(),_=b.length?b:null;Q={post_type:v[0],relative:y,terms:_};M("#dynamic_embed_options_post_type").val(Q.post_type).trigger("change");M("#dynamic_embed_options_relative").val(Q.relative).trigger("change")}else{}}else if(m=="codeview"){var w=j.find("textarea"),k=o.clone();F.modulebuttons=k.find("modulebuttons");k.find("modulebuttons").remove();k.find("single, multi").removeAttr("contenteditable spellcheck id dir style class");var x=C.util.trim(k.html().replace(/\u200c/g,"&zwnj;").replace(/\u200d/g,"&zwj;"));w.show().html(x)}l=C.$.template.offset().top+(F.offset.top-C.$.window.height()/2+F.height/2);l=Math.max(C.$.template.offset().top-200,l);C.util.scroll(l,function(){q.find("h4.editbar-title").html(c);q.find("div.type").hide();q.find("div."+m).show();if(d.data("rss"))M("#dynamic_rss_url").val(d.data("rss"));var e=C.util.top()+C.$.window.height()/2-C.$.template.offset().top-q.height()/2;q.css({top:e});ae();if(m=="single"){if(h){M.each(h,function(e,t){var a=j.find(".conditinal-area").eq(e);a.find("select.condition-fields").val(t.field);a.find("select.condition-operators").val(t.operator);a.find("input.condition-value").val(t.value);a.find("input.input").val(t.html)})}else{var t=f.replace(/&amp;/g,"&");L.val("");if(F.element.parent().is("a")){var a=F.element.parent().attr("href");L.val(a!="#"?a:"");he()}else if(F.element.find("a").length){var i=F.element.find("a");if(t==i.text()){var a=i.attr("href");t=i.text();L.val(a!="#"?a:"")}}j.find("input").eq(0).val(C.util.trim(t))}}else if(m=="img"){var n=parseInt(o[0].style.maxWidth,10)||o.parent().width()||o.width()||null;var l=parseInt(o[0].style.maxHeight,10)||o.parent().height()||o.height()||null;var r=o.attr("src")||o.attr("background");var s=te(r)||"";if(o.parent().is("a")){I.val(o.parent().attr("href").replace("%7B","{").replace("%7D","}"))}else{I.val("")}W.val(o.attr("alt"));R.val(s);H.val(r);o.data("id",o.attr("data-id"));M(".imageurl-popup").toggle(!!s);T.removeAttr("src").attr("src",r);G="attachment";P=j.find(".imagelist");K={id:o.data("id"),src:r,width:o.width()*p,height:o.height()*p};K.asp=K.width/K.height;de();re()}else if(m=="btn"){J.val(o.find("img").attr("alt"));if(o.attr("href"))S.val(o.attr("href").replace("%7B","{").replace("%7D","}"));G="link";P=j.find(".postlist").eq(0);de();M.each(j.find(".buttons img"),function(){var e=M(this);e.css("background-color",o.css("background-color"));e.attr("src")==g?e.parent().addClass("active"):e.parent().removeClass("active")})}else if(m=="auto"){G="post";P=j.find(".postlist").eq(0);de();F.areas=F.element.find("[area]");if(!F.areas.length){F.areas=F.element}F.elements={single:F.areas.eq(u).find("single"),multi:F.areas.eq(u).find("multi"),buttons:F.areas.eq(u).find("a[editable]"),images:F.areas.eq(u).find("img[editable], td[background], th[background]"),expects:F.areas.eq(u).find("[expect]").map(function(){return M(this).attr("expect")}).toArray()};if(F.areas.length>1){q.find(".editbarposition").html(C.util.sprintf(C.l10n.campaigns.for_area,"#"+(u+1))).show()}else{q.find(".editbarposition").hide()}}else if(m=="codeview"){if(U){U.codemirror.clearHistory();U.codemirror.setValue("");j.find(".CodeMirror").remove()}}q.show(0,function(){if(m=="single"){q.find("input").focus().select()}else if(m=="img"){D.val(Math.round(F.width));N.val(Math.round(F.height));E.prop("checked",F.crop)}else if(m=="btn"){D.val(Math.round(n));N.val(Math.round(l))}else if(m=="multi"){M("#mailster-editor").val(f);if(C.util.isTinyMCE&&tinymce.get("mailster-editor")){tinymce.get("mailster-editor").setContent(f);tinymce.execCommand("mceFocus",false,"mailster-editor")}}else if(m=="codeview"){if(wp.codeEditor){U=wp.codeEditor.initialize(w,{codemirror:C.util.codemirrorargs})}else{U={codemirror:A.CodeMirror.fromTextArea(w.get(0),C.util.codemirrorargs)}}}});ae(false)},100)}function de(e,t){var a=M("#post_type_select").find("input:checked").serialize(),i={type:G,posttypes:a,search:X,imagetype:c.filter(":checked").val(),offset:0};if(G=="attachment"){i.id=K.id}P.empty();ae();C.util.ajax("get_post_list",i,function(e){ae(false);if(e.success){n=e.data.itemcount;ue(e.data.html,true);t&&t()}},function(e,t,a){ae(false)})}function ce(){var t=M(this),e=t.data("offset"),a=t.data("type");ae();var i=M("#post_type_select").find("input:checked").serialize();C.util.ajax("get_post_list",{type:a,posttypes:i,search:X,imagetype:c.filter(":checked").val(),offset:e,itemcount:n},function(e){ae(false);if(e.success){n=e.data.itemcount;t.remove();ue(e.data.html,false)}},function(e,t,a){ae(false)});return false}function me(){var e=M(this);var t=e.scrollTop();var a=e.innerHeight();var i=this.scrollHeight;if(!d&&t+a>=i-15){e.find(".load-more-posts").click()}}function fe(){var e=M(this),t=C.util.trim("attachment"==G?Z.val():Y.val());if(!e.is(":checked")&&X==t){return false}X=t;clearTimeout(r);r=setTimeout(function(){de()},500)}function he(){M("#single-link").slideDown(200);L.focus().select();G="link";P=j.find(".postlist").eq(0);de();return false}function ue(e,t,a){if(!a)a=P;if(t)a.empty();if(!a.html())a.html("<ul></ul>");a.find("ul").append(e)}function pe(){M(".imageurl-popup").toggle();if(!R.val()&&K.src.indexOf(location.origin)==-1&&K.src.indexOf("dummy.mailster.co")==-1){R.val(K.src)}R.focus().select();return false}function ge(){if(!wp.media.frames.mailster_editbar){wp.media.frames.mailster_editbar=wp.media({title:C.l10n.campaigns.select_image,library:{type:"image"},multiple:false});wp.media.frames.mailster_editbar.on("select",function(){var e=wp.media.frames.mailster_editbar.state().get("selection").first().toJSON(),t=M("img").data({id:e.id,name:e.name,src:e.url});de(null,function(){le(null,t)})})}wp.media.frames.mailster_editbar.open()}function ve(t){clearTimeout(timeout);timeout=setTimeout(function(){if(!t)return;var e=C.util.trim(t.save());F.element.html(e)},100)}function be(){q.removeClass("current-"+F.type).hide();ae(false);M("#single-link").hide();C.trigger("refresh");C.trigger("save");return false}t.save=b;t.open=oe;t.cancel=_;C.editbar=t;return C}(mailster||{},jQuery,window,document);