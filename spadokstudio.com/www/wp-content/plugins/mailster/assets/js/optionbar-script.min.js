mailster=function(d,l,s,e){"use strict";var o;d.optionbar={};d.optionbar.undos=[];d.optionbar.currentUndo=0;d.optionbar.undo=function(){if(d.optionbar.currentUndo){d.optionbar.currentUndo--;d.editor.setContent(d.optionbar.undos[d.optionbar.currentUndo],100,false);d.$.optionbar.find("a.redo").removeClass("disabled");if(!d.optionbar.currentUndo){l(this).addClass("disabled")}}};d.optionbar.redo=function(){var e=d.optionbar.undos.length;if(d.optionbar.currentUndo<e-1){d.optionbar.currentUndo++;d.editor.setContent(d.optionbar.undos[d.optionbar.currentUndo],100,false);d.$.optionbar.find("a.undo").removeClass("disabled");if(d.optionbar.currentUndo>=e-1){l(this).addClass("disabled")}}};d.optionbar.removeModules=function(){if(confirm(d.l10n.campaigns.remove_all_modules)){var e=d.$.iframe.contents().find("modules");var o=e.find("module");e.slideUp(function(){o.remove();e.html("").show();d.trigger("refresh");d.trigger("save")})}};d.optionbar.codeView=function(){var e;if(d.$.iframe.is(":visible")){e=d.editor.getStructure(d.editor.getFrameContent());d.$.optionbar.find("a.code").addClass("loading");d.trigger("disable");d.util.ajax("toggle_codeview",{bodyattributes:e.parts[2],content:e.content,head:e.head},function(e){d.$.optionbar.find("a.code").addClass("active").removeClass("loading");d.$.html.hide();d.$.content.val(e.data.content);if(wp.codeEditor){o=wp.codeEditor.initialize(d.$.content,{codemirror:d.util.codemirrorargs})}else{o={codemirror:s.CodeMirror.fromTextArea(d.$.content.get(0),d.util.codemirrorargs)}}d.$.optionbar.find("a").not("a.redo, a.undo, a.code").addClass("disabled")},function(e,o,t){d.$.optionbar.find("a.code").addClass("active").removeClass("loading");d.trigger("enable")})}else{e=d.editor.getStructure(o.codemirror.getValue());o.codemirror.clearHistory();d.$.optionbar.find("a.code").addClass("loading");d.trigger("disable");d.util.ajax("toggle_codeview",{bodyattributes:e.parts[2],content:e.content,head:e.head},function(e){d.editor.setContent(e.data.content,100,true,e.data.style);d.$.html.show();d.$.content.hide();l(".CodeMirror").remove();d.$.optionbar.find("a.code").removeClass("active").removeClass("loading");d.$.optionbar.find("a").not("a.redo, a.undo, a.code").removeClass("disabled");d.trigger("enable")},function(e,o,t){d.$.optionbar.find("a.code").addClass("active").removeClass("loading");d.trigger("enable")})}return false};d.optionbar.plainText=function(){if(d.$.iframe.is(":visible")){d.$.optionbar.find("a.plaintext").addClass("active");d.$.html.hide();d.$.excerpt.show();d.$.plaintext.show();d.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.precheck").addClass("disabled")}else{d.$.html.show();d.$.plaintext.hide();d.$.optionbar.find("a.plaintext").removeClass("active");d.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.precheck").removeClass("disabled");d.trigger("refresh")}};d.optionbar.openSaveDialog=function(){tb_show(d.l10n.campaigns.save_template,"#TB_inline?x=1&width=480&height=320&inlineId=mailster_template_save",null);l("#new_template_name").focus().select()};d.optionbar.precheck=function(){if(d.$.optionbar.find("a.precheck").is(".loading")){return false}d.$.optionbar.find("a.precheck").addClass("loading");d.precheck.open(function(){d.$.optionbar.find("a.precheck").removeClass("loading")});return};d.optionbar.dfw=function(e){if(e.type=="mouseout"&&!/DIV|H3/.test(e.target.nodeName)){return}if(!d.$.body.hasClass("focus-on")){d.$.body.removeClass("focus-off").addClass("focus-on");d.$.wpbody.on("mouseleave.dfw",d.optionbar.dfw);d.$.optionbar.find("a.dfw").addClass("active");if(d.$.window.scrollTop()<t()){d.util.scroll(t()-80)}}else{d.$.body.removeClass("focus-on").addClass("focus-off");d.$.wpbody.off("mouseleave",d.optionbar.dfw);d.$.optionbar.find("a.dfw").removeClass("active")}};d.editable&&d.$.document.on("click","button.save-template",r).on("click","button.save-template-cancel",tb_remove);d.editable&&d.$.optionbar.on("click","a",false).on("click","a.save-template",d.optionbar.openSaveDialog).on("click","a.clear-modules",d.optionbar.removeModules).on("click","a.precheck",d.optionbar.precheck).on("click","a.undo",d.optionbar.undo).on("click","a.redo",d.optionbar.redo).on("click","a.code",d.optionbar.codeView).on("click","a.plaintext",d.optionbar.plainText).on("click","a.dfw",d.optionbar.dfw).on("click","a.template",n).on("click","a.file",i);d.editable&&d.$.window.on("scroll.optionbar",a).on("resize.optionbar",function(){d.$.window.trigger("scroll.optionbar")});d.editable&&d.events.push("editorLoaded",function(){d.optionbar.undos.push(d.editor.getFrameContent())});l(".meta-box-sortables").on("sortstop",function(e,o){d.$.window.trigger("resize.optionbar")});function t(){if(!d.dom.template)return 0;return d.$.template.offset().top}function a(){var e=d.util.top();if(e<t()||e>t()+d.$.template.height()-0){if(d.dom.body&&/fixed-optionbar/.test(d.dom.body.className)){d.$.body.removeClass("fixed-optionbar");d.$.optionbar.width("auto")}}else{if(d.dom.body&&!/fixed-optionbar/.test(d.dom.body.className)){d.$.body.addClass("fixed-optionbar");d.$.optionbar.width(d.$.template.width()-22)}}}function n(e){var o=l(this);o.parent().find("ul").eq(0).slideToggle(100)}function i(){s.onbeforeunload=null;s.location=this.href}function r(){d.trigger("disable");var e=l("#new_template_name").val();if(!e){return false}d.trigger("save");var a=l("#new_template-ajax-loading").css("display","inline"),o=l("#new_template_modules").is(":checked"),t=l("#new_template_active_modules").is(":checked"),n=l("#new_template_saveas_dropdown").val(),i=!!parseInt(l('input[name="new_template_overwrite"]:checked').val(),10),r=d.editor.getContent();d.util.ajax("create_new_template",{name:e,modules:o,activemodules:t,overwrite:i?n:false,template:l("#mailster_template_name").val(),content:r,head:d.$.head.val()},function(e){a.hide();if(e.success){if(s.wp){s.wp=null}s.onbeforeunload=null;s.location=e.data.url}else{alert(e.data.msg)}},function(e,o,t){a.hide()});return false}return d}(mailster||{},jQuery,window,document);