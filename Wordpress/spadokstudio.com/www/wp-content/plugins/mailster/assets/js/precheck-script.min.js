mailster=function(e,t,a,r){"use strict";var s={},i,c=t(".mailster-precheck"),n=t(".precheck-status"),l=t(".precheck-score"),o=t("#precheck-ajax-loading"),d=t("#precheck-authentication"),h=t(".precheck-run-btn"),u=t(".precheck-toggle-structure"),p=t(".precheck-toggle-images"),f=t(".mailster-preview-iframe"),m,g,k,v=0,b=true,_=false;e.precheck=e.precheck||{};c.on("click",".precheck-switch",y).on("click",".precheck-run-btn",j).on("click",".precheck-toggle-images",D).on("click",".precheck-toggle-structure",L).on("mouseenter",".assets-table tr",M).on("mouseleave",".assets-table tr",M).on("click",".change-receiver",I).on("click","#precheck-agree",Q);t(".precheck-subscriber").on("focus",function(){t(this).select()}).autocomplete({source:function(t,a){e.util.ajax("search_subscribers",{id:e.campaign_id,term:t.term},function(e){a(e)},function(e,t,a){})},appendTo:".precheck-emailheader",minLength:3,select:function(e,a){t("#subscriber_id").val(a.item.id);B()},change:function(e,a){if(!a.item){t("#subscriber_id").val(0);B()}}});function w(t,a){var r=e.l10n.precheck[t]||t;l.removeAttr("class").addClass("precheck-score precheck-status-"+t);if(a){n.html(n.html()+r)}else{n.html(r)}}function C(a){var r=t('<div class="error"><p><strong>'+a+"</strong></p></div>").hide().appendTo(t(".score-message")).slideDown(200).delay(200).fadeIn().delay(8e3).fadeTo(200,0).delay(1500).slideUp(200,function(){r.remove()});e.error(a)}function x(e){o.css("visibility",e?"visible":"hidden")}function y(){var e=t(this).data("dimensions");t(".device.desktop").width(e.w).height(e.h);t(".precheck-resize").find(".button").removeClass("active");t(this).addClass("active")}function j(){$();x(true);w("sending");h.prop("disabled",true);v=0;t(".precheck-status-icon").html("");e.util.ajax("send_test",{precheck:true,subscriber_id:t("#subscriber_id").val(),formdata:t("#post").serialize(),to:t("#mailster_testmail").val(),content:e.$.content.val(),head:e.$.head.val(),plaintext:e.$.excerpt.val()},function(e){if(e.success){i=e.data.id;setTimeout(function(){w("checking");T(1)},3e3)}else{C(e.data.msg);x(false);h.prop("disabled",false)}},function(e,t,a){x(false);h.prop("disabled",false)})}function $(){c.find("summary").removeAttr("class");c.find(".precheck-result").empty();w("ready")}function T(a){if(a>10){C(e.l10n.precheck.email_not_sent);x(false);h.prop("disabled",false);return}e.util.ajax("precheck",{id:i},function(r){if(r.success){if(!r.data.ready){setTimeout(function(){T(++a)},3e3)}else{w("collecting");t(".precheck-status-icon").html(e.util.sprintf("%s of 100",100));t.when.apply(t,[A("blocklist"),A("spam_report"),A("authentication"),A("message"),A("links","tests/links"),A("images","tests/images")]).done(function(e){w("finished");x(false);h.prop("disabled",false)})}}if(r.data.error){C(r.data.error);x(false);h.prop("disabled",false)}},function(e,t,a){x(false);h.prop("disabled",false)})}function A(e,a){var r=t("#precheck-"+e),s=r.find("details"),i,c=[];if(s.length){r.find("summary").eq(0).removeAttr("class").addClass("loading");for(var n=0;n<s.length;n++){i=s[n].id.replace("precheck-","");if(i){a="tests/"+i;c.push(q(i,a))}}}else{if(!a)a=e;c.push(q(e,a))}return t.when.apply(t,c).done(function(){var a,r={error:0,warning:0,notice:0,success:0};if(typeof arguments[1]!="string"){for(n in arguments){arguments[n]&&r[arguments[n][0].status]++}if(r.error){a="error"}else if(r.warning){a="warning"}else if(r.notice){a="notice"}else{a="success"}t("#precheck-"+e).find("summary").eq(0).removeClass("loading").addClass("loaded is-"+a)}})}function q(a,r){var s=t("#precheck-"+a),c=s.find("summary").eq(0).removeAttr("class").addClass("loading"),n=s.find(".precheck-result");return e.util.ajax("precheck_result",{id:i,endpoint:r},function(a){if(a.success){c.removeClass("loading").addClass("loaded is-"+a.data.status);if("error"==a.data.status){}t(".precheck-status-icon").html(e.util.sprintf("%s of 100",a.data.points));n.html(a.data.html)}if(a.data.error){C(a.data.error);x(false);h.prop("disabled",false)}},function(e,t,a){x(false);h.prop("disabled",false)})}function I(){t(".precheck-to").hide();t(".change-receiver").hide();t(".precheck-to-input").show().find("input").focus().select()}function z(){m=f.contents().find("html,body");g=m.find("highlighterx");k=m.find("highlightery");b=true;e.trigger("enable")}function B(a){if(!e.editor||!e.editor.loaded){e.events.push("editorLoaded",function(){B(a)});return}var r={id:e.campaign_id,subscriber_id:t("#subscriber_id").val(),content:e.editor.getContent(),head:e.$.head.val(),issue:t("#mailster_autoresponder_issue").val(),subject:e.details.$.subject.val(),preheader:e.details.$.preheader.val()},s=e.$.title.val();$();t(".precheck-status-icon").html("");e.util.ajax("set_preview",r,function(r){f.one("load",z).attr("src",ajaxurl+"?action=mailster_get_preview&hash="+r.data.hash+"&_wpnonce="+r.data.nonce);p.addClass("active");u.removeClass("active");tb_show(s?e.util.sprintf(e.l10n.campaigns.precheck,'"'+s+'"'):e.l10n.campaigns.preview,"#TB_inline?hash="+r.data.hash+"&_wpnonce="+r.data.nonce+"&width="+Math.min(1440,e.$.window.width()-50)+"&height="+(e.$.window.height()-100)+"&inlineId=mailster_precheck_wrap",null);t(".precheck-subject").html(r.data.subject);t(".precheck-subscriber").val(r.data.to);t(".precheck-to").text(r.data.to);a&&a()},function(t,a,r){e.trigger("enable")})}function L(){if(_){m.removeClass("precheck-structure-enabled")}else{m.addClass("precheck-structure-enabled")}u.toggleClass("active");_=!_}function D(){var e=m.find("img");if(!b){m.removeClass("precheck-images-hidden");t.each(e,function(e,a){t(a).attr("src",t(a).attr("data-src")).removeAttr("data-src")})}else{m.addClass("precheck-images-hidden");t.each(e,function(e,a){t(a).attr("data-src",t(a).attr("src")).attr("src","")})}p.toggleClass("active");b=!b}function M(e){var a=t(this),r=a.data(),s,i=e.type;if(!r.el){var c=r.url,n=r.tag,l=r.attr,o=r.index,s=f.contents().find(n+"["+l+'="'+c+'"]')[o];a.data("el",s)}else{s=r.el}if(!s){return}if("mouseleave"==i){m.removeClass("precheck-highlighter");t(s).removeClass("precheck-highlighted");return}else{t(s).addClass("precheck-highlighted");m.addClass("precheck-highlighter")}s.scrollIntoView({behavior:"smooth",block:"center"});var d=s.getBoundingClientRect();g.css({transform:"translate("+d.x+"px, "+(d.y+m.scrollTop())+"px)",width:d.width,height:d.height});k.css({transform:"translate("+d.x+"px, "+(d.y+m.scrollTop())+"px)",width:d.width,height:d.height})}function Q(){if(!t("#precheck-agree-checkbox").is(":checked")){alert(e.l10n.campaigns.agree_precheck_terms);return false}e.util.ajax("precheck_agree",function(t){c.addClass("precheck-terms-agreed");e.precheck.terms_accepted=true})}e.precheck.open=function(a){e.trigger("save");e.trigger("disable");t(".precheck-from").html(t("#mailster_from-name").val());B(a)};e.precheck.start=j;e.precheck.terms_accepted=!!t(".precheck-terms-agreed").length;return e}(mailster||{},jQuery,window,document);