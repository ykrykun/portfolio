mailster=function(j,D,$,I){"use strict";var e=D(".wp-filter"),a=D(".theme-browser"),n=e.find(".filter-links a"),t=e.find(".search-form"),i=e.find(".wp-filter-search"),s=e.find("#typeselector"),l,o,r="",d="",f=1,c=0,u=0,m=i.val(),p=s.val(),h=[],L=false,g=false;n.on("click",function(e){e.preventDefault();if(!L)R(D(this).data("sort"));return});t.on("submit",function(e){e.preventDefault();l&&clearTimeout(l);x()});i.on("keyup change",function(e){if(13==e.keyCode){return}l&&clearTimeout(l);l=setTimeout(x,1e3)});s.on("change",function(e){l&&clearTimeout(l);x()});a.on("click",".theme-screenshot, .more-details",function(){v.open(D(this).closest(".theme"))}).on("click",".update",function(e){e.preventDefault();D(this).addClass("updating-message");U(this.href,D(this).closest(".theme").data("slug"))}).on("click",".download",function(e){e.preventDefault();D(this).addClass("updating-message");k(this.href,D(this).closest(".theme").data("slug"))}).on("click",".popup",function(){var e=this.href;if(!/^https?/.test(e))return true;var t=D(this).data(),a=$.screenLeft!=undefined?$.screenLeft:screen.left,n=$.screenTop!=undefined?$.screenTop:screen.top,i=j.$.window.width(),s=j.$.window.height(),l,o,r;if(/%/.test(t.width)){t.width=i*(parseInt(t.width,10)/100)}if(/%/.test(t.height)){t.height=s*(parseInt(t.height,10)/100)}l=i/2-t.width/2+a;o=s/2-t.height/2+n;r=$.open(e,"mailster_themebrowser","scrollbars=auto,resizable=1,menubar=0,toolbar=0,location=0,directories=0,status=0, width="+t.width+", height="+t.height+", top="+o+", left="+l);if($.focus)r.focus();return false});D(".upload-template").on("click",function(){D(".upload-field").toggle()});j.$.window.on("click",".upload-template",function(){D(".upload-field").show()});j.events.push("documentReady",function(){q();j.$.window.on("scroll.mailster",j.util.throttle(C,500))});j.events.push("windowLoad",function(){D("body").off("mousedown")});var v=function(){if(this===$)return new n;var n=D(".theme-overlay"),i=null,s=null,l=null,e=null,o=n.find(".right"),r=n.find(".left"),t=n.find(".close"),a=n.find(".default"),d=n.find(".campaign"),f=n.find(".edit"),c=n.find(".save"),u=n.find(".delete-theme"),m,p=n.find(".codeeditor textarea"),h={};var g=function(e){if("string"===typeof e){e=D('[data-slug="'+e+'"]')}if(!e||!e.length)return false;n.addClass("loading");n.find(".theme-screenshots img").hide();n.find(".theme-screenshots iframe").hide();n.removeAttr("class");n.addClass("theme-overlay loading");i=e;h=e.data("item");n.find(".theme-name").html(h.name+'<span class="theme-version">'+(h.version?h.version:"")+"</span>");n.find(".theme-author").html(j.util.sprintf("By "+h.author));n.find(".theme-description").html(h.description);n.find(".theme-tags").html(h.tags&&h.tags.length?"<span>Tags:</span> "+h.tags.join(", "):"");if(h.src){n.find(".theme-screenshots iframe").show().attr("src",h.src+"?nocache="+ +new Date)}else{n.find(".theme-screenshots img").attr("src",h.image_full).attr("srcset",h.image_full+" 1x, "+h.image_fullx2+" 2x")}if(h.update_available)n.addClass("has-update");if(h.installed)n.addClass("is-installed");if(h.is_default)n.addClass("is-default");if(h.download)n.addClass("has-download");if(h.purchase_url)n.addClass("has-purchase");var t="";if(h.files){t+='<label>Template Files: <select class="theme-file-selector">';for(var a in h.files){if(h.files.hasOwnProperty(a))t+='<option value="'+a+'">'+h.files[a].label+" ("+a+")</option>"}t+="</select></label>"}n.find(".theme-files").html(t);s=i.prev();l=i.next();r.prop("disabled",!s.length)[!s.length?"addClass":"removeClass"]("disabled");o.prop("disabled",!l.length)[!l.length?"addClass":"removeClass"]("disabled");n.show();E("template",h.slug)},v=function(){M("template");n.hide()},w=function(){g(i.next())},C=function(){g(i.prev())},b=function(){var e=D(".theme-file-selector").val();if("index.html"==e&&confirm(j.util.sprintf(j.l10n.templates.confirm_delete,'"'+h.name+'"'))){S(h.slug);v()}else if(confirm(j.util.sprintf(j.l10n.templates.confirm_delete_file,'"'+e+'"','"'+h.name+'"'))){S(h.slug,e,function(){D(".theme-file-selector").val("index.html").trigger("change").find('option[value="'+e+'"]').remove()})}return false},y=function(){if(confirm(j.util.sprintf(j.l10n.templates.confirm_default,'"'+h.name+'"'))){var t=D('[data-slug="'+h.slug+'"]');L=true;j.util.ajax("default_template",{slug:h.slug},function(e){if(e.success){R("installed",function(){D('[data-slug="'+h.slug+'"]').find(".notice-success").html("<p>"+e.data.msg+"</p>")});t.find(".notice-error").empty()}else{t.find(".notice-error").html("<p>"+e.data.msg+"</p>")}t.removeClass("loading").find(".updating-message").removeClass("updating-message");L=false;v()},function(e,t,a){})}return false},x=function(){I.location=this.href+"&template="+h.slug+"&file="+n.find(".theme-file-selector").val();return false},_=function(){j.util.ajax("load_template_file",{template:h.slug,file:n.find(".theme-file-selector").val()},function(e){n.addClass("is-editor");n.find(".codeeditor h3").html(j.util.sprintf(j.l10n.templates.editing,n.find(".theme-file-selector").val(),'"'+h.name+'"'));D(".CodeMirror").remove();p.val(e.data.html);if(wp.codeEditor){m=wp.codeEditor.initialize(p,{codemirror:j.util.codemirrorargs})}else{m={codemirror:$.CodeMirror.fromTextArea(p.get(0),j.util.codemirrorargs)}}},function(e,t,a){});return false},k=function(){j.util.ajax("set_template_html",{content:m.codemirror.getValue(),slug:h.slug,file:n.find(".theme-file-selector").val()},function(e){n.removeClass("is-editor");D(".CodeMirror").remove();p.val("");n.find(".theme-screenshots iframe").attr("src",n.find(".theme-screenshots iframe").attr("src"))},function(e,t,a){});return false},U=function(){n.addClass("loading");n.find(".theme-screenshots iframe").attr("src",h.files[D(this).val()].src);if(n.is(".is-editor")){_()}},T=function(){o.on("click",w);r.on("click",C);t.on("click",v);u.on("click",b);a.on("click",y);d.on("click",x);f.on("click",_);c.on("click",k);n.on("change",".theme-file-selector",U);n.on("click",".theme-description a",function(e){e.preventDefault();$.open(this.href);return false});n.find(".theme-screenshots iframe").on("load",function(){n.removeClass("loading")});n.find(".theme-screenshots img").on("load",function(){D(this).show()})};T();return{open:g,close:v,next:w,prev:C,delete:b}}();function w(){i.val(P("search"));s.val(P("type")||"term");o=P("browse")||"installed";if(P("search")){x()}else{R(o);v.open(P("template"))}}function C(){var e=j.util.top()+j.$.window.height();if(!L&&e>Math.round(I.documentElement.scrollHeight*.9)&&c>u){f++;F()}}function R(e,t){o&&D("body").removeClass("browse-"+o)&&n.filter('[data-sort="'+o+'"]').removeClass("current");o=e||false;M("template");if(o){y();n.filter('[data-sort="'+o+'"]').addClass("current");E("browse",o);D("body").addClass("browse-"+o);F(t)}}function b(){o&&D("body").removeClass("browse-"+o)&&n.filter('[data-sort="'+o+'"]').removeClass("current");M("browse");M("template");o=false;f=1;h=[]}function y(){M("search");M("type");d="";r="";i.val("");s.val("term");f=1;h=[]}function x(){m=j.util.trim(i.val());m=m.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");p=s.val();if(m&&(r!=m||d!=p)){d=p;r=m;b();F();E("search",m);E("type",p)}return}function _(e){var t=D('[data-slug="'+e+'"]');L=true;t.addClass("loading");t.find(".notice-warning").addClass("updating-message").html("<p>Updating...</p>");j.util.ajax("download_template",{slug:e},function(e){L=false},function(e,t,a){})}function k(e,t){var a=D('[data-slug="'+t+'"]');L=true;a.addClass("loading").find(".request-download").addClass("updating-message");a.find(".notice-warning").addClass("updating-message").html("<p>"+j.l10n.templates.downloading+"</p>");j.util.ajax("download_template",{url:e,slug:t},function(e){if(e.success){a.addClass("is-installed").find(".notice-warning").removeClass("updating-message notice-warning").addClass("notice-success").html("<p>"+j.l10n.templates.downloaded+"</p>");a.find(".notice-error").empty()}else{a.find(".notice-error").html("<p>"+e.data.msg+"</p>")}a.removeClass("loading").find(".updating-message").removeClass("updating-message");L=false},function(e,t,a){})}function U(e,t){var a=D('[data-slug="'+t+'"]');L=true;a.addClass("loading").find(".request-download").addClass("updating-message");a.find(".notice-warning").addClass("updating-message").html("<p>"+j.l10n.templates.updating+"</p>");j.util.ajax("download_template",{url:e,slug:t},function(e){if(e.success){a.find(".notice-warning").removeClass("updating-message notice-warning").addClass("notice-success").html("<p>"+j.l10n.templates.updated+"</p>");a.find(".notice-error").empty();var t=D("#menu-posts-newsletter").find(".current").find(".update-plugins");if(t){if(t.text()>1){t.find(".update-count").text(t.text()-1)}else{t.remove()}}}else{a.find(".notice-error").html("<p>"+e.data.msg+"</p>")}a.removeClass("loading").find(".updating-message").removeClass("updating-message");L=false},function(e,t,a){})}function S(e,t,a){var n=D('[data-slug="'+e+'"]');L=true;n.addClass("loading");j.util.ajax("delete_template",{slug:e,file:t||null},function(e){if(a){n.removeClass("loading");a()}else{n.animate({opacity:0},function(){n.animate({width:0,"margin-right":0},function(){n.remove();L=false})})}},function(e,t,a){})}function T(e,t){var a=D('[data-slug="'+e+'"]');a.find(".notice-error").html("<p>"+D("<div>"+t+"</div>").text()+"</p>")}function F(t){if(f==1){D("body").removeClass("no-results");D("body").addClass("loading-content");a.html("");h=[]}L=true;j.util.ajax("query_templates",{search:i.val(),type:s.val(),browse:P("browse"),page:f},function(e){if(f==1){D("body").removeClass("loading-content");D(".theme-count").html(e.data.total);c=e.data.total}h.concat(e.data.templates);a.append(e.data.html);u=D(".theme").length;if(e.data.error){alert(e.data.error);D("body").addClass("no-results")}else if(!u){D("body").addClass("no-results")}L=false;t&&t()},function(e,t,a){})}function P(e){var t=new URLSearchParams($.location.search);return t.get(e)}function E(e,t){var a=new URLSearchParams($.location.search);a.set(e,t);$.history.pushState({},"",decodeURIComponent($.location.pathname+"?"+a))}function M(e){var t=new URLSearchParams($.location.search);t.delete(e);$.history.pushState({},"",decodeURIComponent($.location.pathname+"?"+t))}function q(){var e=new plupload.Uploader(wpUploaderInit),n=D(".uploadinfo");e.bind("Init",function(e){var t=D("#plupload-upload-ui");if(e.features.dragdrop&&!j.util.isTouchDevice){t.addClass("drag-drop");D("#drag-drop-area").bind("dragover.wp-uploader",function(){t.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){t.removeClass("drag-over")})}else{t.removeClass("drag-drop");D("#drag-drop-area").unbind(".wp-uploader")}if(e.runtime=="html4")D(".upload-flash-bypass").hide()});e.init();e.bind("FilesAdded",function(e,t){setTimeout(function(){e.refresh();e.start()},1)});e.bind("BeforeUpload",function(e,t){});e.bind("UploadFile",function(e,t){});e.bind("UploadProgress",function(e,t){n.html(j.util.sprintf(j.l10n.templates.uploading,t.percent+"%"))});e.bind("Error",function(e,t){n.html(t.message);e.refresh()});e.bind("FileUploaded",function(e,t,a){a=JSON.parse(a.response);if(a.success){location.reload()}else{n.html(a.data.error)}});e.bind("UploadComplete",function(e,t){})}w();j.templates=j.templates||{};j.templates.download=_;j.templates.downloadFromUrl=k;j.templates.delete=S;j.templates.error=T;return j}(mailster||{},jQuery,window,document);